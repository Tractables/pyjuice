<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Construct an HMM &mdash; PyJuice 2.2.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=b21de401"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Query a PC" href="04_query_pc.html" />
    <link rel="prev" title="Construct Simple PCs" href="02_construct_simple_pc.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            PyJuice
          </a>
              <div class="version">
                2.2.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01_train_pc.html">Train a PC</a></li>
<li class="toctree-l2"><a class="reference internal" href="02_construct_simple_pc.html">Construct Simple PCs</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Construct an HMM</a></li>
<li class="toctree-l2"><a class="reference internal" href="04_query_pc.html">Query a PC</a></li>
<li class="toctree-l2"><a class="reference internal" href="05_common_transformations.html">PC Structural Transformation Functions</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../python-api/pyjuice.html">pyjuice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python-api/nodes.html">pyjuice.nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python-api/tensorcircuit.html">pyjuice.TensorCircuit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python-api/structures.html">pyjuice.structures</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PyJuice</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Tutorials</a></li>
      <li class="breadcrumb-item active">Construct an HMM</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/getting-started/tutorials/03_construct_hmm.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-getting-started-tutorials-03-construct-hmm-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<section class="sphx-glr-example-title" id="construct-an-hmm">
<span id="sphx-glr-getting-started-tutorials-03-construct-hmm-py"></span><h1>Construct an HMM<a class="headerlink" href="#construct-an-hmm" title="Link to this heading"></a></h1>
<p>This tutorial demonstrates how to construct an HMM with <code class="code docutils literal notranslate"><span class="pre">pyjuice.inputs</span></code>, <code class="code docutils literal notranslate"><span class="pre">pyjuice.multiply</span></code>, and <code class="code docutils literal notranslate"><span class="pre">pyjuice.summate</span></code>.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># sphinx_gallery_thumbnail_path = &#39;imgs/juice.png&#39;</span>
</pre></div>
</div>
<p>Let’s start by importing the necessary packages.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">pyjuice</span> <span class="k">as</span> <span class="nn">juice</span>
<span class="kn">import</span> <span class="nn">pyjuice.nodes.distributions</span> <span class="k">as</span> <span class="nn">dists</span>
</pre></div>
</div>
<p>We start with specifying the structural parameters of the HMM</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">seq_length</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">num_latents</span> <span class="o">=</span> <span class="mi">2048</span>
<span class="n">num_emits</span> <span class="o">=</span> <span class="mi">4023</span>
</pre></div>
</div>
<p>An important parameter to be determined is the block size, which is crucial for PyJuice to compile efficient models.
Specifically, we want the block size to be large enough so that PyJuice can leverage block-based parallelization.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">block_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">juice</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">max_cdf_power_of_2</span><span class="p">(</span><span class="n">num_latents</span><span class="p">),</span> <span class="mi">1024</span><span class="p">)</span>
</pre></div>
</div>
<p>The number of node blocks is derived accordingly</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">num_node_blocks</span> <span class="o">=</span> <span class="n">num_latents</span> <span class="o">//</span> <span class="n">block_size</span>
</pre></div>
</div>
<p>We use the context manager <cite>set_block_size</cite> to set the block size of all PC nodes.
In the following we assume <cite>T = seq_length</cite> and <cite>K = num_latents</cite></p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">juice</span><span class="o">.</span><span class="n">set_block_size</span><span class="p">(</span><span class="n">block_size</span><span class="p">):</span>
    <span class="c1"># We begin by defining p(X_{T-1}|Z_{T-1}) for all k = 0...K-1</span>
    <span class="n">ns_input</span> <span class="o">=</span> <span class="n">juice</span><span class="o">.</span><span class="n">inputs</span><span class="p">(</span><span class="n">seq_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_node_blocks</span> <span class="o">=</span> <span class="n">num_node_blocks</span><span class="p">,</span>
                            <span class="n">dist</span> <span class="o">=</span> <span class="n">dists</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">num_cats</span> <span class="o">=</span> <span class="n">num_emits</span><span class="p">))</span>

    <span class="n">ns_sum</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">curr_zs</span> <span class="o">=</span> <span class="n">ns_input</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">seq_length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># The emission probabilities p(X_{var}|Z_{var}=k) for all k = 0...K-1</span>
        <span class="n">curr_xs</span> <span class="o">=</span> <span class="n">ns_input</span><span class="o">.</span><span class="n">duplicate</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">tie_params</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># The transition probabilities p(Z_{var+1}|Z_{var})</span>
        <span class="k">if</span> <span class="n">ns_sum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Create both the structure and the transition probabilities</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="n">juice</span><span class="o">.</span><span class="n">summate</span><span class="p">(</span><span class="n">curr_zs</span><span class="p">,</span> <span class="n">num_node_blocks</span> <span class="o">=</span> <span class="n">num_node_blocks</span><span class="p">)</span>
            <span class="n">ns_sum</span> <span class="o">=</span> <span class="n">ns</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Create only the structure and reuse the transition probabilities from `ns_sum`</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="n">ns_sum</span><span class="o">.</span><span class="n">duplicate</span><span class="p">(</span><span class="n">curr_zs</span><span class="p">,</span> <span class="n">tie_params</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">curr_zs</span> <span class="o">=</span> <span class="n">juice</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">curr_xs</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>

    <span class="c1"># The Initial probabilities p(Z_{0})</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="n">juice</span><span class="o">.</span><span class="n">summate</span><span class="p">(</span><span class="n">curr_zs</span><span class="p">,</span> <span class="n">num_node_blocks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">block_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that <code class="code docutils literal notranslate"><span class="pre">ns.duplication</span></code> is a handy function to create duplications of existing node vectors.
For input nodes (e.g., <code class="code docutils literal notranslate"><span class="pre">ns_input.duplicate(var,</span> <span class="pre">tie_params</span> <span class="pre">=</span> <span class="pre">True)</span></code>) we can specify it to define on a new variable.
The argument <code class="code docutils literal notranslate"><span class="pre">tie_params</span> <span class="pre">=</span> <span class="pre">True</span></code> means we want to use the same set of parameters in the original and the duplicated node vector.
The parameters will remain tied after parameter learning, structural transformation, etc.</p>
<p>For sum node vectors, <code class="code docutils literal notranslate"><span class="pre">ns.duplicate</span></code> allows us to specify a new list of children. However, the child nodes must have the same size (same number of node blocks and block size).</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-getting-started-tutorials-03-construct-hmm-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/a6f4e70e566387d03c9a1773c5f52cdb/03_construct_hmm.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">03_construct_hmm.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/4407a3dbbb1547f15d94cab7374d606b/03_construct_hmm.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">03_construct_hmm.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-zip docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/d53424265b3faf11303f2bcbe1bdab7b/03_construct_hmm.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">zipped:</span> <span class="pre">03_construct_hmm.zip</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="02_construct_simple_pc.html" class="btn btn-neutral float-left" title="Construct Simple PCs" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="04_query_pc.html" class="btn btn-neutral float-right" title="Query a PC" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, StarAI.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>